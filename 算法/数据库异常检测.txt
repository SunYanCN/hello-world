
数据库对稳定性要求较高，对异常容忍度非常低。因此，快速的数据库异常发现、定位和止损就变得越来越重要。

而基于AI的数据库异常发现能力，可以基于数据库历史表现情况，对关键指标进行7 * 24小时巡检，能够在异常萌芽状态就发现风险，更早地将异常暴露，辅助研发人员在问题恶化前进行定位和止损。
从已有的历史监控指标中，发现时序数据的变化规律，从而根据数据分布的特点选取合适的算法。
数据的规律主要呈现三种状态：周期、漂移和平稳。因此，我们前期可以针对这些普遍特征的样本进行建模，即可覆盖大部分场景。

对于周期性，可通过计算自相关图，然后通过分析自相关峰的间隔来确定周期性，主要的流程包括以下几个步骤：
提取趋势成分，分离出残差序列。使用移动平均法提取出长期趋势项，跟原序列作差得到残差序列（此处周期性分析与趋势无关，若不分离趋势成分，自相关将显著受到影响，难以识别周期）。
计算残差的循环自相关（Rolling Correlation）序列。通过循环移动残差序列后，与残差序列进行向量点乘运算来计算自相关序列（循环自相关可以避免延迟衰减）。
根据自相关序列的峰值坐标来确定周期T。提取自相关序列的一系列局部最高峰，取横坐标的间隔为周期（如果该周期点对应的自相关值小于给定阈值，则认为无显著周期性）。

在异常检测场景下，我们只需要检测出历史上很平稳，之后出现数据漂移的情况。综合算法性能和实际表现，我们使用了基于中位数滤波的漂移检测方法，主要的流程包含以下几个环节：
中位数平滑
a.根据给定窗口的大小，提取窗口内的中位数来获取时序的趋势成分。
b.窗口需要足够大，以避免周期因素影响，并进行滤波延迟矫正。
c.使用中位数而非均值平滑的原因在于为了规避异常样本的影响。

判断平滑序列是否递增或是递减
a.中位数平滑后的序列数据，若每个点都大于（小于）前一个点，则序列为递增（递减）序列。
b.如果序列存在严格递增或是严格递减的性质，则指标明显存在长期趋势，此时可提前终止。

遍历平滑序列，利用如下两个规则来判断是否存在漂移的现象
a.当前样本点左边序列的最大值小于当前样本点右边序列的最小值，则存在突增漂移（上涨趋势）。
b.当前样本点左边序列的最小值大于当前样本点右边序列的最大值，则存在突降漂移（下跌趋势）。

对于一个时序指标，如果其在任意时刻，它的性质不随观测时间的变化而变化，我们认为这条时序是具备平稳性的。因此，对于具有长期趋势成分亦或是周期性成分的时间序列而言，它们都是不平稳的。
针对这种情况，我们可以通过单位根检验（Augmented Dickey-Fuller Test）[3]来判断给定的时间序列是否平稳。具体地说，对于一条给定时间范围指标的历史数据而言，我们认为在同时满足如下条件的情况下，时序是平稳的：
最近1天的时序数据通过adfuller检验获得的p值小于0.05。
最近7天的时序数据通过adfuller检验获得的p值小于0.05。

常见时序数据检测的算法对比表：
算法\场景	对称分布下适用性	偏态分布下适用性	正态性要求	异常容忍度
3Sigma	高	低	高	低
绝对中位差（MAD）	高	低	高	高
箱形图（Boxplot）	高	中	中	高
极值理论（EVT）	中	高	低	低

绝对中位差，即Median Absolute Deviation(MAD)，是对单变量数值型数据的样本偏差的一种鲁棒性测量，通常由下式计算而得：
MAD=C×median|Xi−median(X)|
Upper=median+k×MAD
Lower=median−k×MAD
其中在先验为正态分布的情况下，一般C选择1.4826，k选择3。
MAD假定样本中间的50%区域均为正常样本，而异常样本落在两侧的50%区域内。
当样本服从正态分布的情况下，MAD指标相较于标准差更能适应数据集中的异常值。
对于标准差，使用的是数据到均值的距离平方，较大的偏差权重较大，异常值对结果影响不能忽视，而对MAD而言少量的异常值不会影响实验的结果，MAD算法对于数据的正态性有较高要求。


箱形图主要通过几个统计量来描述样本分布的离散程度以及对称性，包括：
Q0：最小值（Minimum）
Q1：下四分位数（Lower Quartile）
Q2：中位数（Median）
Q3：上四分位数（Upper Quartile）
Q4：最大值（Maximum）

将Q1与Q3之间的间距称为IQR，当样本偏离上四分位1.5倍的IQR（或是偏离下四分位数1.5倍的IQR）的情况下，将样本视为是一个离群点。
不同于基于正态假设的三倍标准差，通常情况下，箱形图对于样本的潜在数据分布没有任何假定，能够描述出样本的离散情况，且对样本中包含的潜在异常样本有较高的容忍度。
对于有偏数据，Boxplot进行校准后建模更加符合数据分布。

极值理论
真实世界的数据很难用一种已知的分布来概括，例如对于某些极端事件（异常），概率模型（例如高斯分布）往往会给出其概率为0。
极值理论是在不基于原始数据的任何分布假设下，通过推断我们可能会观察到的极端事件的分布，这就是极值分布（EVD）。
其数学表达式如下（互补累积分布函数公式）：
P(X−t>x∣X>t)∼(1+γxδ(t))−1γ
其中t代表样本的经验阈值，对于不同场景可以设置不同取值，γ,δ分别是广义帕累托分布中的形状参数与尺度参数，在给定样本超过人为设定的经验阈值t的情况下，随机变量X-t是服从广义帕累托分布的。
通过极大似然估计方法我们可以计算获得参数估计值γ^与δ^ ，并且通过如下公式来求取模型阈值；
由于通常情况下对于经验阈值t的估计没有先验的信息，因此可以使用样本经验分位数来替代数值t，这里经验分位数的取值可以根据实际情况来选择。

